<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Organization Portal</title>

  <!-- Teams JS SDK v2 -->
  <script src="https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js"></script>
</head>

<body style="font-family:Segoe UI, Arial; padding:16px;">
  <h2>Organization portal</h2>
  <p>If you are not redirected automatically, click below.</p>

  <button id="open" style="padding:10px 14px; font-size:14px;">
    Open SharePoint
  </button>

  <script>
    const url = "https://m365t46240078.sharepoint.com/";

    function oncePerSession(key) {
      if (sessionStorage.getItem(key)) return false;
      sessionStorage.setItem(key, "1");
      return true;
    }

    async function openFromTeams() {
      // Best: Teams-supported open in browser
      if (microsoftTeams?.pages?.openLink) {
        await microsoftTeams.pages.openLink(url);
        return true;
      }

      // Fallback: may be blocked, but try
      window.open(url, "_blank", "noopener,noreferrer");
      return true;
    }

    function redirectHere() {
      // Replace avoids back-button loops
      window.location.replace(url);
    }

    async function initAuto() {
      // Only attempt auto behavior once per session
      if (!oncePerSession("portal_autorun_attempted")) return;

      // If Teams SDK isn't available, do nothing (page stays with button)
      if (!window.microsoftTeams?.app?.initialize) return;

      try {
        await microsoftTeams.app.initialize();

        const ctx = await microsoftTeams.app.getContext();
        const host = (ctx?.app?.host?.name || "").toLowerCase();

        if (host === "teams") {
          // Teams: open in browser via openLink (reliable)
          await openFromTeams();
        } else if (host === "outlook") {
          // Outlook: redirect current view straight to SharePoint
          redirectHere();
        } else {
          // Other host (office, etc.): do nothing automatically
        }
      } catch (e) {
        // If init/getContext fails, don't break the page
        console.warn("Teams init/getContext failed:", e);
      }
    }

    // Button fallback: works everywhere
    document.getElementById("open").addEventListener("click", async () => {
      // If in Teams, prefer openLink; otherwise open normally
      try {
        if (window.microsoftTeams?.app?.initialize) {
          await microsoftTeams.app.initialize();
          const ctx = await microsoftTeams.app.getContext();
          const host = (ctx?.app?.host?.name || "").toLowerCase();

          if (host === "teams") {
            await openFromTeams();
            return;
          }
          if (host === "outlook") {
            redirectHere();
            return;
          }
        }
      } catch (_) {
        // ignore and fall back
      }

      window.open(url, "_blank", "noopener,noreferrer");
    });

    // Auto-run after DOM is ready
    window.addEventListener("DOMContentLoaded", initAuto);
  </script>
</body>
</html>
